# Firmware for One Voice Card

## What is a Voice Board?

The synthesizer is mainly composed of three types of circuits:
- The **conductor board**, which receives MIDI instructions from external sources and distributes them to the voice board.
- The **controller board**, which serves as a user interface for sending MIDI instructions (via an I²C bus) to the conductor board.
- The **voice board**, which is an analog monophonic synthesizer that can function, to some extent, autonomously.

### What Does a Voice Board Do?

A voice board receives MIDI instructions from the conductor board via the I²C bus. Its primary function is to generate the corresponding monophonic analog voice using the AS3397 chip. Everything is coordinated by an RP2040/RP2530-based Raspberry Pi Pico microcontroller.

### What's Inside a Voice Board?

The two main components are the **AS3397 chip** and the **Raspberry Pi Pico microcontroller**. Of course, there are additional electronic components, but detailed knowledge of them is not necessary for working on the firmware. For more technical details on the hardware, see [relevant documentation or section].


# List of Files and Overview of Their Functions

In the near future, all files will be extensively commented and will have dedicated Doxygen documentation.

- **`voice.ino`**: The main file that integrates all auxiliary files to fetch MIDI data from the I²C bus and send the correct voltage to the AS3397 chip.
- **`as3397.h` / `as3397.cpp`**: This class represents the interface with the AS3397 chip. For instance, the chip requires ten control voltages for configuration, which are generated using PWM signals from the RP2040 microcontroller. As a result, this class contains 10 (+4) PWM members. This is the most complex file to understand, as it is closely tied to certain hardware-specific aspects of the AS3397 chip.
- **`ADSR.h` / `ADSR.cpp`**: A basic implementation of an Attack-Decay-Sustain-Release (ADSR) envelope. Nothing special.
- **`LFO.h` / `LFO.cpp`**: A basic implementation of a Low-Frequency Oscillator (LFO), optimized for computational efficiency.
- **`DSO.h` / `DSO.cpp`**: The Digital Signal Oscillator (DSO) class and instructions. The AS3397 chip has an external input just before its analog filter, where the chip's analog oscillator is mixed with a digital signal generated by the RP2040 microcontroller (see **X** for more technical details). Currently, the DSO functions as a relatively simple wavetable synthesizer, but it could be easily extended (see **X**).
- **`Synth.h`**: This file instantiates and initializes the **AS3397**, **LFO**, **ADSR**, and **DSO** objects. It also contains the `updateCtrl` and `updateAudio` callback functions, which are automatically called using two timers on the RP2040 (see `voice.ino`).  
  - The **`updateCtrl`** callback, called at **CONTROL_RATE** Hz (typically **500 Hz**), updates the LFO and ADSR values and sends them to the AS3397 object to adjust sound generation.  
  - The **`updateAudio`** callback, called at **AUDIO_RATE** Hz (typically **62,500 Hz**), calculates the new output value of the DSO and sends it to the AS3397 object to update the DSO.

  This file specifically defines some important global variables:
  ```c
  As3397 as(AUDIO_RATE);
  LFO lfo1(CONTROL_RATE);
  ADSR eg1(CONTROL_RATE);
  ADSR eg2(CONTROL_RATE);
  DSO dso(AUDIO_RATE);
  ```
  Additionally, several other global variables are defined to manage various synthesizer parameters, such as `freqA`, which stores the current frequency of analog oscillator A.

- **`Midimanager.h`**: Handles MIDI messages, decodes them, and modifies the corresponding synthesizer parameters.
- **`midicontrol.h.oxy`**: Defines the MIDI CC numbers assigned to each parameter.
- **`led.h` / `led.cpp`**: Provides basic feedback using the onboard LED of the Pi Pico board.
- **`aspin.h`**: Defines the pin connections between the AS3397 chip and the RP2040. This is entirely hardware-dependent and should not be modified unless the corresponding hardware connections on the voice board have also been changed.
- **`tables.h`**: Contains raw wavetable data for the DSO.

# How to Compile the Firmware?

# Modifying the Firmware: Where to Start?

## Setting Up a Workspace

## Modifying the Synth Structure

Currently, each voice has one LFO and two envelope generators (EGs). 

The LFO is assigned to:
- The filter resonance
- The PWM modulation of the square wave
- The pan

The first envelope is assigned to the general volume. The second envelope is assigned to the filter cutoff.

These are very basic routings for a synth, but more LFOs and EGs could be added with additional modulation destinations and even intermodulation (e.g., an LFO modulating the attack time of an EG).

Other types of modulation could also be integrated, such as step sequencers, random/chaos generators, etc.

### Adding New LFOs and/or EGs:
- Instantiate them in `synth.h`
- Update their behavior in the `synth.h` **updateCtrl** callback  
  _(NB: Beware of circular modulation, where modulator A modulates modulator B while B simultaneously modulates A.)_
- If needed, modify `Midimanager.h` so that MIDI commands can be assigned to this new modulator.

### Creating a New Type of Modulation:
- Create the dedicated `.h` and `.cpp` class.
- Follow the same process as adding a new LFO or EG.


## Modifying the DSO
